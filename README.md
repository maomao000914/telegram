# Telegram 群组消息监听与转发工具

这是一个 Python 工具，可以登录 Telegram 账号、获取群组列表，并监听指定群组中指定用户的消息，将消息实时转发到指定的 QQ 群。

## 功能

1. 登录现有的 Telegram 账号
2. 获取账号的群组列表
3. 用户指定需要监听的群组（支持多个）
4. 支持为不同群组设置不同的监听用户（基于用户ID）
5. 实时监听新消息和编辑消息
6. 将消息转发到指定的 QQ 群
7. 消息时间自动转换为北京时间显示

## 安装步骤

### 1. 克隆或下载项目

确保你已经下载了这个项目。

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 获取 Telegram API 凭证

1. 访问 [Telegram API](https://my.telegram.org/) 官网
2. 使用你的手机号登录
3. 点击 "API development tools" 并创建一个新的应用
4. 记下 `API_ID` 和 `API_HASH`

### 4. 配置项目

编辑 `config.py` 文件，填入你的 API 凭证和 QQ 机器人配置:

```python
# Telegram API 配置
API_ID = 123456  # 你的API ID
API_HASH = 'your_api_hash_here'  # 你的API Hash

# QQ机器人配置 (用于消息转发)
QQ_BOT_UIN = ""        # 用于登录的QQ号
QQ_TARGET_GROUP = ""   # 目标QQ群号码
QQ_WS_URI = "ws://localhost:3001"  # NapCat的WebSocket地址
QQ_BOT_TOKEN = ""               # 如果设置了access_token，请填写
```

## 使用方法

运行程序:

```bash
python main.py
```

首次运行时，程序会要求你输入手机号和验证码来登录 Telegram。

程序运行后会：

1. 显示你的账号信息
2. 列出所有群组并编号
3. 提示你输入要监听的群组编号（多个编号用逗号分隔）
4. 如果选择了多个群组，会为每个群组分别设置要监听的用户ID
5. 如果只选择了一个群组，会统一设置要监听的用户ID（多个ID用逗号分隔）
6. 开始监听并转发匹配的消息到 QQ 群

## 转发消息格式

转发到 QQ 群的消息格式如下：

```
[Telegram转发]
群组: Test Group
发送者: John Doe
时间: 2023-10-25 14:30:25
内容: 这是一条测试消息
```

对于编辑过的消息，会显示为：

```
[Telegram转发-编辑消息]
群组: Test Group
发送者: John Doe
时间: 2023-10-25 14:35:25
内容: 这是一条测试消息(已修改)
```

## 工作原理

- 使用 [Telethon](https://github.com/LonamiWebs/Telethon) 库与 Telegram API 交互
- 使用 [NapCat](https://github.com/NapNeko/NapCat) 框架与 QQ 通信
- 程序会创建一个会话文件，以便下次无需重新登录
- 使用 `events.NewMessage` 和 `events.MessageEdited` 事件处理器监听新消息和编辑消息
- 只转发配置的群组和用户消息

## 重要说明：关于消息接收问题

### 为什么需要手机端保持在线？

Telegram采用"被动推送"机制，只有当客户端处于活跃状态时才会接收实时消息。这意味着：

1. **手机端必须保持登录** - 手机端Telegram应用需要保持登录状态
2. **群组需要处于"活跃"状态** - 建议在手机端打开需要监听的群组
3. **网络连接要稳定** - 手机端需要有稳定的网络连接

### 程序如何解决这个问题？

程序实现了以下机制来提高消息接收的可靠性：

1. **保持连接活跃** - 程序会定期向Telegram服务器发送请求以保持连接活跃
2. **自动重连机制** - 当连接断开时会尝试自动重连
3. **连接状态监控** - 实时监控连接状态并报告异常

### 最佳实践建议

为了确保能够正常接收消息，请遵循以下建议：

1. **多设备登录** - 同时在手机和电脑上保持登录状态
2. **保持手机在线** - 手机端Telegram需要保持在线状态
3. **打开监听群组** - 在手机端打开需要监听的群组
4. **使用专用监控账号** - 考虑使用专门的Telegram账号进行监控
5. **避免频繁注销** - 不要频繁注销和重新登录，保持会话文件的持久化存储

## 如何获取群组和成员信息

### 获取群组列表：
运行程序后会自动显示群组列表及对应编号

### 获取用户ID：
用户ID是Telegram用户的唯一数字标识符，可以通过以下方式获取：
1. 使用Telegram机器人查询
2. 通过群组成员列表查看
3. 通过消息转发查看发送者信息

## 注意事项

- 请妥善保管你的 API 凭证和会话文件
- 不要将凭证分享给他人
- 遵守 Telegram 的使用条款
- 如果启用了两步验证，可能需要输入密码
- 使用QQ转发功能时需遵守相关法律法规

## 文件说明

- `main.py`: 主程序文件
- `config.py`: 配置文件，包含 API 凭证和 QQ 机器人配置
- `requirements.txt`: Python 依赖包列表
- `telegram_session.session`: 登录会话文件 (首次运行后生成)

## 常见问题

### 如何重新登录？

删除 `telegram_session.session` 文件，然后重新运行程序。

### 如何监听多个群组？

在输入群组编号时，使用逗号分隔多个编号，例如：`1, 3, 5`

### 如何监听多个用户？

在输入用户ID时，使用逗号分隔多个ID，例如：`123456789, 987654321`

### 如何监听所有用户的消息？

在用户ID输入提示时，直接按回车键跳过

### 为什么收不到实时消息？

请检查以下几点：
1. 手机端Telegram是否保持在线
2. 需要监听的群组是否在手机端打开
3. 网络连接是否稳定
4. 是否使用了专用的监控账号
